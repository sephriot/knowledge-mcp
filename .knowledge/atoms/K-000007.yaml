id: K-000007
title: Bug Fixes in knowledge-mcp Go Implementation
type: fact
status: active
confidence: high
content:
    summary: 'Fixed 6 bugs/issues in the knowledge-mcp Go implementation: (1) tag filtering case sensitivity inconsistency in ListAtoms, (2) data loss on update - tags/sources/links not preserved, (3) missing validation for Type/Status/Confidence enums, (4) silent error in ID parsing, (5) silent error in index rebuild, (6) no concurrency protection in IndexManager.'
    details: |-
        ## Fixes Applied

        ### 1. Tag filtering case sensitivity (tools/atoms.go)
        ListAtoms used case-sensitive tag matching while Search used case-insensitive. Fixed by adding strings.ToLower() to both the entry tags and filter tags.

        ### 2. Data loss on update (tools/upsert.go)
        When updating an atom, if input.Tags/Sources/Links were nil, they were replaced with empty slices instead of preserving existing values. Fixed to preserve existing values like pitfalls already did.

        ### 3. Enum validation (tools/upsert.go)
        Added validation at start of Upsert() to check Type.IsValid(), Status.IsValid(), and Confidence.IsValid() before processing.

        ### 4. ID parsing (models/atom.go)
        GetNextID() ignored Sscanf errors. Fixed to check return value (n == 1) before using parsed number.

        ### 5. Index rebuild errors (storage/index.go)
        Errors loading atoms during rebuild were silently ignored. Now collects errors and logs them to stderr.

        ### 6. Concurrency protection (storage/index.go)
        Added sync.RWMutex to IndexManager with internal loadLocked/saveLocked methods. All public methods now properly acquire locks.
    pitfalls: []
    update_notes:
        - date: "2026-01-21"
          note: Initial creation
language: go
created_at: "2026-01-21"
updated_at: "2026-01-21"
tags:
    - knowledge-mcp
    - bugfix
    - go
    - concurrency
    - validation
sources:
    - kind: repo_path
      ref: tools/atoms.go
    - kind: repo_path
      ref: tools/upsert.go
    - kind: repo_path
      ref: models/atom.go
    - kind: repo_path
      ref: storage/index.go
links: []
supersedes: []
